<% content_for :breadcrumbs do %>
  <li>Users</li>
<% end %>

<% content_for :page_actions do %>
  <%= link_to new_new_admin_user_path, class: "btn btn-primary" do %>
    <i class="fas fa-user-plus mr-2"></i>
    New User
  <% end %>
<% end %>

<!-- Search and Filters -->
<div class="card bg-base-100 shadow-sm mb-6">
  <div class="card-body">
    <%= form_with url: new_admin_users_path, method: :get, local: true, class: "flex flex-wrap gap-4 items-end" do |f| %>
      <div class="form-control flex-1 min-w-64">
        <%= f.label :search, "Search Users", class: "label" %>
        <%= f.text_field :search, value: params[:search], placeholder: "Search by name or email...", 
            class: "input input-bordered w-full" %>
      </div>
      
      <div class="form-control">
        <%= f.label :filter, "Filter", class: "label" %>
        <%= f.select :filter, 
            options_for_select([
              ['All Users', ''],
              ['Admin Users', 'admins'],
              ['Regular Users', 'regular']
            ], params[:filter]), 
            {}, { class: "select select-bordered" } %>
      </div>
      
      <div class="form-control">
        <%= f.submit "Filter", class: "btn btn-primary" %>
        <%= link_to "Clear", new_admin_users_path, class: "btn btn-ghost" %>
      </div>
    <% end %>
  </div>
</div>

<!-- Users Table -->
<div class="card bg-base-100 shadow-xl">
  <div class="card-body">
    <% if @users.any? %>
      <div class="overflow-x-auto">
        <table class="table table-zebra w-full">
          <thead>
            <tr>
              <th>User</th>
              <th>Contact</th>
              <th>Role</th>
              <th>Activity</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% @users.each do |user| %>
              <tr class="hover">
                <td>
                  <div class="flex items-center space-x-3">
                    <div class="avatar placeholder">
                      <div class="bg-primary text-primary-content rounded-full w-12">
                        <span class="text-xl"><%= user.name.first.upcase %></span>
                      </div>
                    </div>
                    <div>
                      <div class="font-bold text-base-content">
                        <%= link_to user.name, new_admin_user_path(user), class: "hover:text-primary" %>
                      </div>
                      <div class="text-sm text-base-content/70">
                        Joined <%= time_ago_in_words(user.created_at) %> ago
                      </div>
                    </div>
                  </div>
                </td>
                
                <td>
                  <div class="text-sm">
                    <div class="font-semibold text-base-content">
                      <i class="fas fa-envelope mr-1"></i>
                      <%= user.email %>
                    </div>
                    <% if user.phone.present? %>
                      <div class="text-base-content/70">
                        <i class="fas fa-phone mr-1"></i>
                        <%= user.phone %>
                      </div>
                    <% end %>
                  </div>
                </td>
                
                <td>
                  <% if user.admin? %>
                    <div class="badge badge-warning">
                      <i class="fas fa-shield-alt mr-1"></i>
                      Admin
                    </div>
                  <% else %>
                    <div class="badge badge-ghost">
                      <i class="fas fa-user mr-1"></i>
                      User
                    </div>
                  <% end %>
                </td>
                
                <td>
                  <div class="flex flex-col space-y-1">
                    <div class="badge badge-primary badge-sm">
                      <i class="fas fa-hand-holding-usd mr-1"></i>
                      <%= pluralize(user.tips.count, 'tip') %>
                    </div>
                    <div class="badge badge-success badge-sm">
                      <i class="fas fa-dollar-sign mr-1"></i>
                      $<%= user.tips.sum(:amount).to_i %>
                    </div>
                    <% if user.event.present? %>
                      <div class="badge badge-secondary badge-sm">
                        <i class="fas fa-calendar mr-1"></i>
                        <%= truncate(user.event.title, length: 15) %>
                      </div>
                    <% end %>
                  </div>
                </td>
                
                <td>
                  <div class="flex space-x-1">
                    <%= link_to new_admin_user_path(user), class: "btn btn-ghost btn-sm" do %>
                      <i class="fas fa-eye"></i>
                    <% end %>
                    <%= link_to edit_new_admin_user_path(user), class: "btn btn-ghost btn-sm" do %>
                      <i class="fas fa-edit"></i>
                    <% end %>
                    <% unless user == current_user %>
                      <%= link_to toggle_admin_new_admin_user_path(user), method: :patch, 
                          class: "btn btn-ghost btn-sm #{'text-warning' if user.admin?}" do %>
                        <i class="fas fa-user-shield"></i>
                      <% end %>
                      <%= link_to new_admin_user_path(user), method: :delete, 
                          class: "btn btn-ghost btn-sm text-error",
                          confirm: "Are you sure you want to delete this user? This will also delete all their tips." do %>
                        <i class="fas fa-trash"></i>
                      <% end %>
                    <% end %>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
      
      <!-- Pagination would go here -->
      <% if defined?(@pagy) %>
        <div class="flex justify-center mt-6">
          <%== pagy_nav(@pagy) if @pagy.pages > 1 %>
        </div>
      <% end %>
      
    <% else %>
      <!-- Empty State -->
      <div class="text-center py-12">
        <div class="w-24 h-24 bg-base-200 rounded-full flex items-center justify-center mx-auto mb-6">
          <i class="fas fa-user-plus text-3xl text-base-content/30"></i>
        </div>
        <h3 class="text-xl font-semibold text-base-content mb-2">No users found</h3>
        <% if params[:search].present? || params[:filter].present? %>
          <p class="text-base-content/70 mb-4">Try adjusting your search criteria</p>
          <%= link_to "Clear filters", new_admin_users_path, class: "btn btn-ghost mr-2" %>
        <% else %>
          <p class="text-base-content/70 mb-4">Get started by creating your first user</p>
        <% end %>
        <%= link_to new_new_admin_user_path, class: "btn btn-primary" do %>
          <i class="fas fa-user-plus mr-2"></i>
          Create User
        <% end %>
      </div>
    <% end %>
  </div>
</div>

<!-- Summary Stats -->
<% if @users.any? %>
  <div class="stats shadow mt-6 w-full">
    <div class="stat">
      <div class="stat-figure text-primary">
        <i class="fas fa-users text-2xl"></i>
      </div>
      <div class="stat-title">Total Users</div>
      <div class="stat-value text-primary"><%= @users.count %></div>
    </div>
    
    <div class="stat">
      <div class="stat-figure text-warning">
        <i class="fas fa-user-shield text-2xl"></i>
      </div>
      <div class="stat-title">Admin Users</div>
      <div class="stat-value text-warning"><%= @users.select(&:admin?).count %></div>
    </div>
    
    <div class="stat">
      <div class="stat-figure text-success">
        <i class="fas fa-hand-holding-usd text-2xl"></i>
      </div>
      <div class="stat-title">Total Tips</div>
      <div class="stat-value text-success"><%= @users.sum { |u| u.tips.count } %></div>
    </div>
    
    <div class="stat">
      <div class="stat-figure text-accent">
        <i class="fas fa-dollar-sign text-2xl"></i>
      </div>
      <div class="stat-title">Tips Value</div>
      <div class="stat-value text-accent">$<%= @users.sum { |u| u.tips.sum(:amount) }.to_i %></div>
    </div>
  </div>
<% end %>
