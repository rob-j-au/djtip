<% content_for :breadcrumbs do %>
  <li>Tips</li>
<% end %>

<!-- Search and Filters -->
<div class="card bg-base-100 shadow-sm mb-6">
  <div class="card-body">
    <%= form_with url: admin_tips_path, method: :get, local: true, class: "space-y-4" do |f| %>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <div class="form-control">
          <%= f.label :search, "Search", class: "label" %>
          <%= f.text_field :search, value: params[:search], placeholder: "Search tips...", 
              class: "input input-bordered w-full" %>
        </div>
        
        <div class="form-control">
          <%= f.label :event_id, "Event", class: "label" %>
          <%= f.select :event_id, 
              options_from_collection_for_select(@events, :id, :title, params[:event_id]),
              { prompt: "All Events" }, { class: "select select-bordered" } %>
        </div>
        
        <div class="form-control">
          <%= f.label :user_id, "User", class: "label" %>
          <%= f.select :user_id, 
              options_from_collection_for_select(@users, :id, :name, params[:user_id]),
              { prompt: "All Users" }, { class: "select select-bordered" } %>
        </div>
        
        <div class="form-control">
          <%= f.label :min_amount, "Min Amount", class: "label" %>
          <%= f.number_field :min_amount, value: params[:min_amount], step: 0.01, 
              class: "input input-bordered", placeholder: "0.00" %>
        </div>
      </div>
      
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="form-control">
          <%= f.label :max_amount, "Max Amount", class: "label" %>
          <%= f.number_field :max_amount, value: params[:max_amount], step: 0.01, 
              class: "input input-bordered", placeholder: "1000.00" %>
        </div>
        
        <div class="form-control">
          <%= f.label :date_from, "From Date", class: "label" %>
          <%= f.date_field :date_from, value: params[:date_from], 
              class: "input input-bordered" %>
        </div>
        
        <div class="form-control">
          <%= f.label :date_to, "To Date", class: "label" %>
          <%= f.date_field :date_to, value: params[:date_to], 
              class: "input input-bordered" %>
        </div>
      </div>
      
      <div class="flex justify-between items-center">
        <div class="flex space-x-2">
          <%= f.submit "Apply Filters", class: "btn btn-primary" %>
          <%= link_to "Clear", admin_tips_path, class: "btn btn-ghost" %>
        </div>
        
        <% if @total_amount > 0 %>
          <div class="badge badge-success badge-lg">
            Total: $<%= number_with_delimiter(@total_amount.to_f, precision: 2) %>
          </div>
        <% end %>
      </div>
    <% end %>
  </div>
</div>

<!-- Tips Table -->
<div class="card bg-base-100 shadow-xl">
  <div class="card-body">
    <% if @tips.any? %>
      <div class="overflow-x-auto">
        <table class="table table-zebra w-full">
          <thead>
            <tr>
              <th>Tip Details</th>
              <th>User</th>
              <th>Event</th>
              <th>Amount</th>
              <th>Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% @tips.each do |tip| %>
              <tr class="hover">
                <td>
                  <div class="flex items-center space-x-3">
                    <div class="w-3 h-3 bg-success rounded-full"></div>
                    <div>
                      <div class="font-bold text-success text-lg">
                        $<%= tip.amount.to_f %>
                      </div>
                      <% if tip.message.present? %>
                        <div class="text-sm text-base-content/70 italic max-w-xs">
                          "<%= truncate(tip.message, length: 50) %>"
                        </div>
                      <% else %>
                        <div class="text-sm text-base-content/50">No message</div>
                      <% end %>
                    </div>
                  </div>
                </td>
                
                <td>
                  <div class="flex items-center space-x-3">
                    <% if tip.user.image_data? && tip.user.image_url(:thumb) %>
                      <div class="avatar">
                        <div class="w-10 rounded-full ring ring-primary ring-offset-base-100 ring-offset-2">
                          <%= image_tag tip.user.image_url(:thumb), alt: tip.user.name, class: "rounded-full object-cover" %>
                        </div>
                      </div>
                    <% else %>
                      <div class="avatar placeholder">
                        <div class="bg-gradient-to-br from-primary to-secondary text-primary-content rounded-full w-10">
                          <span class="text-sm font-bold"><%= tip.user.name.first.upcase %></span>
                        </div>
                      </div>
                    <% end %>
                    <div>
                      <div class="font-semibold text-base-content">
                        <%= link_to tip.user.name, admin_user_path(tip.user), class: "hover:text-primary" %>
                      </div>
                      <div class="text-sm text-base-content/70">
                        <%= tip.user.email %>
                      </div>
                    </div>
                  </div>
                </td>
                
                <td>
                  <div>
                    <div class="font-semibold text-base-content">
                      <%= link_to tip.event.title, admin_event_path(tip.event), class: "hover:text-primary" %>
                    </div>
                    <div class="text-sm text-base-content/70">
                      <i class="fas fa-map-marker-alt mr-1"></i>
                      <%= tip.event.location %>
                    </div>
                    <div class="text-sm text-base-content/70">
                      <i class="fas fa-calendar mr-1"></i>
                      <%= tip.event.date.strftime("%b %d, %Y") %>
                    </div>
                  </div>
                </td>
                
                <td>
                  <div class="text-center">
                    <div class="badge badge-success badge-lg font-bold">
                      $<%= tip.amount.to_f %>
                    </div>
                    <div class="text-xs text-base-content/50 mt-1">
                      <%= tip.currency %>
                    </div>
                  </div>
                </td>
                
                <td>
                  <div class="text-sm">
                    <div class="font-semibold text-base-content">
                      <%= tip.created_at.strftime("%b %d, %Y") %>
                    </div>
                    <div class="text-base-content/70">
                      <%= tip.created_at.strftime("%I:%M %p") %>
                    </div>
                    <div class="text-base-content/50">
                      <%= time_ago_in_words(tip.created_at) %> ago
                    </div>
                  </div>
                </td>
                
                <td>
                  <div class="flex space-x-1">
                    <%= link_to admin_tip_path(tip), class: "btn btn-ghost btn-sm" do %>
                      <i class="fas fa-eye"></i>
                    <% end %>
                    <%= link_to edit_admin_tip_path(tip), class: "btn btn-ghost btn-sm" do %>
                      <i class="fas fa-edit"></i>
                    <% end %>
                    <%= link_to admin_tip_path(tip), method: :delete, 
                        class: "btn btn-ghost btn-sm text-error",
                        confirm: "Are you sure you want to delete this tip?" do %>
                      <i class="fas fa-trash"></i>
                    <% end %>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
      
      <!-- Pagination -->
      <% if defined?(@pagy) %>
        <div class="flex justify-center mt-6">
          <%== pagy_nav(@pagy) if @pagy.pages > 1 %>
        </div>
      <% end %>
      
    <% else %>
      <!-- Empty State -->
      <div class="text-center py-12">
        <div class="w-24 h-24 bg-base-200 rounded-full flex items-center justify-center mx-auto mb-6">
          <i class="fas fa-hand-holding-usd text-3xl text-base-content/30"></i>
        </div>
        <h3 class="text-xl font-semibold text-base-content mb-2">No tips found</h3>
        <% if params.values.any?(&:present?) %>
          <p class="text-base-content/70 mb-4">Try adjusting your search criteria</p>
          <%= link_to "Clear filters", admin_tips_path, class: "btn btn-ghost mr-2" %>
        <% else %>
          <p class="text-base-content/70 mb-4">Tips will appear here when users start tipping</p>
        <% end %>
      </div>
    <% end %>
  </div>
</div>

<!-- Summary Stats -->
<% if @tips.any? %>
  <div class="stats shadow mt-6 w-full">
    <div class="stat">
      <div class="stat-figure text-primary">
        <i class="fas fa-hand-holding-usd text-2xl"></i>
      </div>
      <div class="stat-title">Tips Shown</div>
      <div class="stat-value text-primary"><%= @tips.count %></div>
    </div>
    
    <div class="stat">
      <div class="stat-figure text-success">
        <i class="fas fa-dollar-sign text-2xl"></i>
      </div>
      <div class="stat-title">Total Amount</div>
      <div class="stat-value text-success">$<%= number_with_delimiter(@total_amount.to_f, precision: 2) %></div>
    </div>
    
    <div class="stat">
      <div class="stat-figure text-secondary">
        <i class="fas fa-chart-line text-2xl"></i>
      </div>
      <div class="stat-title">Average Tip</div>
      <div class="stat-value text-secondary">
        $<%= number_with_delimiter((@total_amount / @tips.count).to_f, precision: 2) %>
      </div>
    </div>
    
    <div class="stat">
      <div class="stat-figure text-accent">
        <i class="fas fa-users text-2xl"></i>
      </div>
      <div class="stat-title">Unique Tippers</div>
      <div class="stat-value text-accent"><%= @tips.distinct(:user_id).count %></div>
    </div>
  </div>
<% end %>
